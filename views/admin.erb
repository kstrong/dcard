<div id="errMsg" class="row">
  <% if flash[:error] %>
  <div class="alert alert-error span5">
    <a class="close" data-dismiss="alert">&times;</a>
    <%= flash[:error] %>
  </div>
  <% end %>
</div>

<section>
  <h2>Codes <small>click to edit</small></h2>
  <div class="well codes-outer">
    <ul id="codes">
    <% @codes.each do |code| %>
      <li data-id="<%= code.id %>"><%= code.code %></li>
    <% end %>
    </ul>
    <div class="clear"></div>
  </div>
</section>

<form class="form-inline">
  <button id="genCode" class="btn">
    <i class="icon-plus"></i>
    Generate Code
  </button>
  <input type="text" class="span2" id="codeword" placeholder="Code Word..." />
  <button id="saveCode" class="btn btn-success hide">
    <i class="icon-ok-circle"></i>
    Save Code
  </button>
</form>

<section>
  <div class="row">
    <div class="span4">
      <h2>Downloads</h2>
    </div>
    <div class="span2">
      <a id="checkall" class="btn btn-small"><i class="icon-ok-circle"></i>Check all</a>
    </div>
    <div class="span2">
      <a id="uncheckall" class="btn btn-small"><i class="icon-remove-circle"></i>Uncheck all</a>
    </div>
  </div>
  <div class="well">
    <% @downloads.each do |download| %>
    <div class="row">
      <div class="span1">
        <input data-id="<%= download.id %>" class="dl-check pull-left" type="checkbox" />
      </div>
      <div class="span3"><%= download.title %></div>
      <div class="span2">
          <span><%= download.format %></span>
      </div>
      <div class="span2">
        <a class="downLink" href="<%= url("download/#{session[:code]}/#{download.id}") %>">http</a> | <a href="#">torrent</a>
      </div>
      <div class="span2 center">
        <input data-id="<%= download.id %>" class="dl-count input-mini" type="text" value="<%= @default_count %>" />
      </div>
    </div>
    <% end %>
  </div>
</section>

<section>
  <button class="btn" data-toggle="collapse" data-target="#newdl">
    <i class="icon-plus"></i>
    Add New Download
  </button>
  <div id="newdl" class="collapse in">
    <form method="post" action="<%= url('download/new') %>" enctype="multipart/form-data">
      <div class="control-group">
        <label class="control-label">Title</label>
        <div class="controls">
          <input type="text" name="title" />
        </div>
      </div>
      <div class="control-group">
        <label class="control-label">File</label>
        <div class="controls">
          <input type="file" name="download_file" />
        </div>
      </div>
      <button class="btn btn-primary" type="submit">Upload</button>
    </form>
  </div>
</section>

<% content_for :scripts do %>
<script type="text/javascript">
jQuery(function ($) {

  $('.collapse').collapse();
  
  var code_downloads = { <%= 
    @codes.map { |code| 
      code.id.to_s << ": " << code.code_downloads.all.map { |dc| 
        { :id => dc.download_id, :count => dc.count } 
      }.to_json.to_s 
    }.join(',') 
  %>}; 

  function setDownloads(code_id) {
    $('.dl-check').attr('checked', false);
    $('.dl-count').val(<%= @default_count %>);

    if (!code_downloads[code_id]) {
      return;
    }

    $.each(code_downloads[code_id], function (idx, dl) {
      $('.dl-check[data-id='+dl.id+']').attr('checked', 'checked');
      $('.dl-count[data-id='+dl.id+']').val(dl.count)
    }); 
  }

  $('.dl-check, .dl-count').change(function () {
    if (current_code_id) {
      $('#saveCode').fadeIn();
    }
  });

  var current_code_id = 0;
  $('#codes li').live('click', function () {
    var $this = $(this);
    if ($this.hasClass('selected')) {
      $this.removeClass('selected');
      current_code_id = 0;
      $('#saveCode').fadeOut();
    }
    else {
      $('#codes li.selected').removeClass('selected');
      $this.addClass('selected');
      current_code_id = $this.attr('data-id');
    }
    setDownloads(current_code_id);
  });

  function saveDownloads() {
    var downloads = {};
    $('.dl-check:checked').each(function () {
      var thisid = $(this).attr('data-id');
      var count = $('.dl-count[data-id='+thisid+']').val();
      downloads[thisid] = count;
    });

    return downloads;
  }

  $('#genCode').click(function () {
    var downloads = saveDownloads();
    var params = {
      downloads: downloads
    };

    if ($('#codeword').val()) {
      params.codeword = $('#codeword').val();
    }

    $.post('<%= url('codes') %>', params, function (response) {
      console.log(response);

      if (response.code) {
        $('#codes').append($('<li data-id="'+response.id+'">'+response.code+'</li>'));
        var code_dls = [];
        for (var dlid in downloads) {
          code_dls.push({id: dlid, count: downloads[dlid]});
        }
        code_downloads[response.id] = code_dls;
      }
      else if (response.error) {
        displayError(response.error);
      }
    }).error(function (err) {
      console.log(err);
    });

    return false;
  });

  $('#saveCode').click(function () {
    var code_id   = $('#codes li.selected').attr('data-id');
    var downloads = saveDownloads();

    var params = {
      downloads: downloads
    };

    $.ajax({
      url: '<%= url('codes') %>/'+code_id, 
      type: 'PUT',
      dataType: 'json',
      data: params,
      success: function (response) {
        console.log(response);

        if (response.code) {
          var code_dls = [];
          for (var dlid in downloads) {
            code_dls.push({id: dlid, count: downloads[dlid]});
          }
          code_downloads[response.id] = code_dls;
        }
        else if (response.error) {
          displayError(response.error);
        }
      }
    });

    return false;
  });

  $('#checkall').click(function () {
    $('.dl-check').attr('checked', 'checked');
  });

  $('#uncheckall').click(function () {
    $('.dl-check').attr('checked', false);
  });

  function displayError(errmsg) {
    var err = '<div class="alert alert-error span5"><a class="close" data-dismiss="alert">&times;</a>';
    err += errmsg;
    err += '</div>';

    $('#errMsg').css('display', 'none').append($(err)).fadeIn();
  }

});
</script>
<% end %>